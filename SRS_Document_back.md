# เอกสารข้อกำหนดซอฟต์แวร์ (Software Requirements Specification - SRS)
## ระบบ Backend API สำหรับแอปพลิเคชันสุขภาพและโภชนาการ (TCX)

---

## สารบัญ

1. [ภาพรวมระบบ](#1-ภาพรวมระบบ)
2. [Use Case Diagram](#2-use-case-diagram)
3. [DFD Level 0 และ Level 1](#3-dfd-level-0-และ-level-1)
4. [State Diagram](#4-state-diagram)
5. [Sequence Diagram](#5-sequence-diagram)

---

## 1. ภาพรวมระบบ

### 1.1 คำอธิบายระบบ
ระบบ Backend API สำหรับแอปพลิเคชันสุขภาพและโภชนาการ (TCX) ที่ให้บริการ:
- การจัดการผู้ใช้และการยืนยันตัวตน (Authentication & Authorization)
- การคำนวณและติดตามค่า BMI (Body Mass Index)
- การค้นหาข้อมูลอาหารและสินค้าผ่าน OpenFoodFacts API
- การสแกนบาร์โค้ดจากรูปภาพเพื่อดึงข้อมูลสินค้า
- การจัดการข้อมูลทั่วไป (Generic CRUD Operations)

### 1.2 เทคโนโลยีที่ใช้
- **Backend Framework**: Node.js + Express.js
- **Database**: Supabase (PostgreSQL)
- **Authentication**: Supabase Auth (JWT)
- **External APIs**: OpenFoodFacts API
- **Image Processing**: Jimp, ZXing Library

### 1.3 ตารางข้อมูลหลัก
- **users**: ข้อมูลผู้ใช้
- **bmi_records**: ประวัติการบันทึกค่า BMI
- **auth.users**: ข้อมูลการยืนยันตัวตน (Supabase Auth)

---

## 2. Use Case Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                         ระบบ TCX Backend                        │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                       │
        ▼                     ▼                       ▼
┌───────────────┐    ┌───────────────┐      ┌───────────────┐
│   ผู้ใช้ทั่วไป   │    │  ผู้ใช้ที่ลงทะเบียน  │      │   ระบบภายนอก   │
│  (Guest User) │    │ (Registered   │      │ (External     │
│               │    │    User)      │      │   System)     │
└───────────────┘    └───────────────┘      └───────────────┘
        │                     │                       │
        │                     │                       │
        │                     │                       │
        ▼                     ▼                       ▼
┌──────────────────────────────────────────────────────────────┐
│                      Use Cases                               │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│ 1. Authentication & User Management                         │
│    ├─ UC1: สมัครสมาชิก (Sign Up)                            │
│    ├─ UC2: เข้าสู่ระบบ (Sign In)                            │
│    ├─ UC3: ออกจากระบบ (Sign Out)                            │
│    ├─ UC4: ดูข้อมูลโปรไฟล์ (View Profile)                    │
│    └─ UC5: อัปเดตข้อมูลโปรไฟล์ (Update Profile)              │
│                                                              │
│ 2. BMI Management                                            │
│    ├─ UC6: บันทึกข้อมูล BMI (Record BMI)                     │
│    ├─ UC7: ดูประวัติ BMI (View BMI History)                 │
│    ├─ UC8: คำนวณค่า BMI (Calculate BMI)                     │
│    └─ UC9: ดูค่า BMI ล่าสุด (View Latest BMI)                │
│                                                              │
│ 3. Food Search & Product Information                        │
│    ├─ UC10: ค้นหาอาหาร (Search Food)                         │
│    ├─ UC11: ดูข้อมูลสินค้าตาม Barcode (Get Product by Barcode)│
│    ├─ UC12: ดูสินค้าแบบสุ่ม (Get Random Products)            │
│    └─ UC13: ดูข้อมูลโภชนาการ (View Nutrition Info)           │
│                                                              │
│ 4. Barcode Scanning                                          │
│    ├─ UC14: สแกนบาร์โค้ดจากรูปภาพ (Scan Barcode from Image) │
│    ├─ UC15: อ่านบาร์โค้ด (Read Barcode)                      │
│    └─ UC16: ดึงข้อมูลสินค้าจากบาร์โค้ด (Get Product from Barcode)│
│                                                              │
│ 5. Data Management                                           │
│    ├─ UC17: ดึงข้อมูลจากตาราง (Get Data from Table)          │
│    ├─ UC18: เพิ่มข้อมูล (Insert Data)                        │
│    ├─ UC19: อัปเดตข้อมูล (Update Data)                      │
│    └─ UC20: ลบข้อมูล (Delete Data)                           │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 2.1 รายละเอียด Use Cases หลัก

#### UC1: สมัครสมาชิก (Sign Up)
- **Actor**: ผู้ใช้ทั่วไป
- **Precondition**: ไม่มี
- **Main Flow**:
  1. ผู้ใช้กรอก email, password, weight, height, calories (optional)
  2. ระบบสร้างบัญชีผู้ใช้ใน Supabase Auth
  3. ระบบคำนวณค่า BMI
  4. ระบบบันทึกข้อมูล BMI ลงฐานข้อมูล
  5. ระบบส่งข้อมูลผู้ใช้และ BMI กลับไป
- **Postcondition**: ผู้ใช้มีบัญชีและข้อมูล BMI ถูกบันทึก

#### UC2: เข้าสู่ระบบ (Sign In)
- **Actor**: ผู้ใช้ที่ลงทะเบียน
- **Precondition**: มีบัญชีในระบบ
- **Main Flow**:
  1. ผู้ใช้กรอก email และ password
  2. ระบบตรวจสอบข้อมูล
  3. ระบบดึงข้อมูล BMI ล่าสุด
  4. ระบบส่ง session token และข้อมูลผู้ใช้กลับไป
- **Postcondition**: ผู้ใช้เข้าสู่ระบบสำเร็จ

#### UC6: บันทึกข้อมูล BMI (Record BMI)
- **Actor**: ผู้ใช้ที่ลงทะเบียน
- **Precondition**: เข้าสู่ระบบแล้ว
- **Main Flow**:
  1. ผู้ใช้กรอก weight, height, calories (optional)
  2. ระบบคำนวณค่า BMI
  3. ระบบกำหนด category (underweight, normal, overweight, obese)
  4. ระบบบันทึกข้อมูลลง bmi_records table
  5. ระบบส่งข้อมูล BMI ที่บันทึกกลับไป
- **Postcondition**: มีข้อมูล BMI ใหม่ในระบบ

#### UC10: ค้นหาอาหาร (Search Food)
- **Actor**: ผู้ใช้ทั่วไป, ผู้ใช้ที่ลงทะเบียน
- **Precondition**: ไม่มี
- **Main Flow**:
  1. ผู้ใช้กรอกคำค้นหา
  2. ระบบส่งคำขอไปยัง OpenFoodFacts API
  3. ระบบรับข้อมูลสินค้า
  4. ระบบจัดรูปแบบข้อมูล
  5. ระบบส่งข้อมูลสินค้ากลับไป
- **Postcondition**: ผู้ใช้ได้รับรายการสินค้าที่ค้นหา

#### UC14: สแกนบาร์โค้ดจากรูปภาพ (Scan Barcode from Image)
- **Actor**: ผู้ใช้ทั่วไป, ผู้ใช้ที่ลงทะเบียน
- **Precondition**: ไม่มี
- **Main Flow**:
  1. ผู้ใช้อัปโหลดรูปภาพที่มีบาร์โค้ด
  2. ระบบอ่านรูปภาพด้วย Jimp
  3. ระบบประมวลผลรูปภาพ (resize, grayscale, contrast)
  4. ระบบอ่านบาร์โค้ดด้วย ZXing Library
  5. ระบบดึงข้อมูลสินค้าจาก OpenFoodFacts API
  6. ระบบส่งข้อมูลบาร์โค้ดและสินค้ากลับไป
- **Postcondition**: ผู้ใช้ได้รับข้อมูลบาร์โค้ดและสินค้า

---

## 3. DFD Level 0 และ Level 1

### 3.1 DFD Level 0 (Context Diagram)

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│                    ระบบ TCX Backend API                     │
│                                                             │
│  ┌──────────────┐                                          │
│  │              │                                          │
│  │  ผู้ใช้       │◄─────────────────────────────────────────┤
│  │  (User)      │                                          │
│  │              │                                          │
│  └──────┬───────┘                                          │
│         │                                                   │
│         │ Request (HTTP)                                    │
│         │ Response (JSON)                                   │
│         │                                                   │
│  ┌──────▼──────────────────────────────────────────────┐    │
│  │                                                    │    │
│  │            Backend API Server                      │    │
│  │                                                    │    │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  │    │
│  │  │   Auth    │  │    BMI     │  │   Food     │  │    │
│  │  │  Module   │  │   Module   │  │  Module    │  │    │
│  │  └────────────┘  └────────────┘  └────────────┘  │    │
│  │                                                    │    │
│  └──────┬───────────────────┬───────────────────┬───┘    │
│         │                   │                   │        │
│         │                   │                   │        │
└─────────┼───────────────────┼───────────────────┼────────┘
          │                   │                   │
          │                   │                   │
    ┌─────▼─────┐      ┌──────▼──────┐    ┌───────▼──────┐
    │           │      │             │    │             │
    │ Supabase  │      │ Supabase    │    │ OpenFood    │
    │   Auth    │      │  Database   │    │  Facts API  │
    │           │      │             │    │             │
    └───────────┘      └─────────────┘    └─────────────┘
```

### 3.2 DFD Level 1 (Process Decomposition)

```
┌─────────────────────────────────────────────────────────────────┐
│                      ระบบ TCX Backend API                        │
└─────────────────────────────────────────────────────────────────┘

┌──────────────┐
│   ผู้ใช้      │
└──────┬───────┘
       │
       │ 1.0 Request
       │
┌──────▼──────────────────────────────────────────────────────────┐
│                        1.0 รับคำขอ (Receive Request)            │
│                        Express Router                            │
└──────┬──────────────────────────────────────────────────────────┘
       │
       ├─────────────────┬─────────────────┬──────────────────┐
       │                 │                 │                  │
       ▼                 ▼                 ▼                  ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ 2.0         │  │ 3.0         │  │ 4.0         │  │ 5.0         │
│ Authentication│  │ BMI         │  │ Food        │  │ Barcode     │
│ Management   │  │ Management  │  │ Search      │  │ Scanning    │
└──────┬───────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘
       │                │                 │                 │
       │                │                 │                 │
       ▼                ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                     2.1 ตรวจสอบ Authentication                  │
│                     (Verify Authentication)                      │
│  - ตรวจสอบ JWT Token                                             │
│  - ตรวจสอบ email/password                                        │
└──────┬──────────────────────────────────────────────────────────┘
       │
       ├─────────────────┬─────────────────┐
       │                 │                 │
       ▼                 ▼                 ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ 2.2         │  │ 2.3         │  │ 2.4         │
│ สร้างบัญชี   │  │ เข้าสู่ระบบ  │  │ ออกจากระบบ  │
│ (Sign Up)   │  │ (Sign In)   │  │ (Sign Out)  │
└──────┬──────┘  └──────┬──────┘  └──────┬──────┘
       │                │                 │
       │                │                 │
       ▼                ▼                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                     3.1 คำนวณ BMI                                │
│                     (Calculate BMI)                              │
│  - รับ weight, height                                            │
│  - คำนวณ BMI = weight / (height/100)²                           │
│  - กำหนด category                                                │
└──────┬──────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────────┐
│                     3.2 บันทึกข้อมูล BMI                         │
│                     (Save BMI Record)                            │
│  - บันทึกลง bmi_records table                                   │
└──────┬──────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────────┐
│                     4.1 ค้นหาอาหาร                                │
│                     (Search Food)                                │
│  - ส่งคำขอไป OpenFoodFacts API                                   │
│  - รับข้อมูลสินค้า                                                │
│  - จัดรูปแบบข้อมูล                                                │
└──────┬──────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────────┐
│                     5.1 อ่านบาร์โค้ด                              │
│                     (Read Barcode)                              │
│  - อ่านรูปภาพด้วย Jimp                                            │
│  - ประมวลผลรูปภาพ                                                 │
│  - อ่านบาร์โค้ดด้วย ZXing                                        │
└──────┬──────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────────┐
│                     5.2 ดึงข้อมูลสินค้า                           │
│                     (Get Product Info)                           │
│  - ส่ง barcode ไป OpenFoodFacts API                              │
│  - รับข้อมูลสินค้า                                                │
└──────┬──────────────────────────────────────────────────────────┘
       │
       │
       │
┌──────▼──────────────────────────────────────────────────────────┐
│                        6.0 ส่งคำตอบ (Send Response)               │
│                        JSON Response                             │
└──────┬──────────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────┐
│   ผู้ใช้      │
└──────────────┘

═══════════════════════════════════════════════════════════════════
Data Stores:
═══════════════════════════════════════════════════════════════════

D1: Supabase Auth (auth.users)
    - ข้อมูลการยืนยันตัวตน
    - JWT tokens

D2: Supabase Database (users table)
    - ข้อมูลผู้ใช้
    - email, full_name, avatar_url

D3: Supabase Database (bmi_records table)
    - ประวัติ BMI
    - weight, height, bmi, category, calories, date

D4: External API (OpenFoodFacts)
    - ข้อมูลสินค้าและโภชนาการ
    - Product details, nutrition info
```

### 3.2 System Features

#### 3.2.1 Activity Diagram: การสแกนบาร์โค้ดและดึงข้อมูลสินค้า

```
┌─────────────────────────────────────────────────────────────────┐
│   Activity Diagram: Barcode Scanning and Product Retrieval      │
└─────────────────────────────────────────────────────────────────┘

                    [เริ่มต้น]
                       │
                       ▼
            ┌─────────────────────┐
            │  ผู้ใช้อัปโหลดรูปภาพ  │
            │  (Upload Image)     │
            └──────────┬──────────┘
                       │
                       ▼
            ┌─────────────────────┐
            │  ตรวจสอบไฟล์รูปภาพ   │
            │  (Validate Image)   │
            └──────────┬──────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ▼              ▼              ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ ไฟล์ถูกต้อง  │ │ ไฟล์ใหญ่เกิน │ │ รูปแบบไม่ถูก │
│ (Valid)    │ │ (Too Large) │ │ (Invalid)   │
└──────┬──────┘ └──────┬──────┘ └──────┬──────┘
       │               │               │
       │               │               │
       │               ▼               ▼
       │      ┌─────────────────────┐
       │      │  Return Error 400   │
       │      │  (File Size/Type)   │
       │      └─────────────────────┘
       │
       ▼
┌─────────────────────┐
│ อ่านรูปภาพด้วย Jimp  │
│ (Read Image)        │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ ประมวลผลรูปภาพ       │
│ (Process Image)     │
│ - Resize            │
│ - Grayscale         │
│ - Contrast          │
│ - Normalize         │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ แปลงเป็น Luminance  │
│ (Convert to         │
│  Luminance Data)    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ สร้าง Binary Bitmap │
│ (Create Binary      │
│  Bitmap)            │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ ตั้งค่า Barcode      │
│ Format Hints        │
│ (EAN-13, EAN-8,     │
│  UPC-A, UPC-E, etc.)│
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ อ่านบาร์โค้ดด้วย ZXing│
│ (Decode Barcode)   │
└──────────┬──────────┘
           │
    ┌──────┼──────┐
    │      │      │
    ▼      ▼      ▼
┌──────┐ ┌──────┐ ┌──────┐
│สำเร็จ│ │ล้มเหลว│ │ล้มเหลว│
│      │ │      │ │      │
└──┬───┘ └──┬───┘ └──┬───┘
   │        │        │
   │        │        │
   │        ▼        │
   │ ┌─────────────┐ │
   │ │ ลองปรับรูปภาพ│ │
   │ │ อีกครั้ง     │ │
   │ │ (Retry with │ │
   │ │  adjusted   │ │
   │ │  settings)  │ │
   │ └──────┬──────┘ │
   │        │        │
   │        └────────┘
   │
   ▼
┌─────────────────────┐
│ ได้บาร์โค้ด          │
│ (Barcode Retrieved) │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ ส่งคำขอไป            │
│ OpenFoodFacts API   │
│ (Request Product    │
│  by Barcode)        │
└──────────┬──────────┘
           │
    ┌──────┼──────┐
    │      │      │
    ▼      ▼      ▼
┌──────┐ ┌──────┐ ┌──────┐
│พบสินค้า│ │ไม่พบ │ │Error │
│      │ │      │ │      │
└──┬───┘ └──┬───┘ └──┬───┘
   │        │        │
   │        │        │
   │        ▼        ▼
   │ ┌─────────────┐ │
   │ │ Return Error│ │
   │ │ 404/500     │ │
   │ └─────────────┘ │
   │                 │
   ▼                 │
┌─────────────────────┐
│ จัดรูปแบบข้อมูลสินค้า │
│ (Format Product     │
│  Data)              │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ บันทึก Transaction  │
│ History             │
│ (Log Transaction)   │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ ส่ง Response กลับ   │
│ (Return Response)   │
│ - Barcode           │
│ - Product Info      │
│ - Nutrition Info    │
└──────────┬──────────┘
           │
           ▼
        [สิ้นสุด]
```

#### 3.2.2 Activity Diagram: การสมัครสมาชิกและบันทึกข้อมูล BMI

```
┌─────────────────────────────────────────────────────────────────┐
│   Activity Diagram: User Sign Up and BMI Registration           │
└─────────────────────────────────────────────────────────────────┘

                    [เริ่มต้น]
                       │
                       ▼
            ┌─────────────────────┐
            │  ผู้ใช้กรอกข้อมูล      │
            │  (Enter Data)      │
            │  - Email           │
            │  - Password        │
            │  - Weight (optional)│
            │  - Height (optional)│
            │  - Calories (optional)│
            └──────────┬──────────┘
                       │
                       ▼
            ┌─────────────────────┐
            │  ตรวจสอบข้อมูลที่จำเป็น│
            │  (Validate Required │
            │   Fields)           │
            └──────────┬──────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ▼              ▼              ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ข้อมูลครบถ้วน │ │Email/Password│ │ข้อมูลไม่ถูกต้อง│
│ (Complete)  │ │  ไม่ครบ      │ │ (Invalid)   │
└──────┬──────┘ └──────┬──────┘ └──────┬──────┘
       │               │               │
       │               │               │
       │               ▼               ▼
       │      ┌─────────────────────┐
       │      │ Return Error 400     │
       │      │ (Missing Fields)    │
       │      └─────────────────────┘
       │
       ▼
┌─────────────────────┐
│ สร้างบัญชีผู้ใช้      │
│ ใน Supabase Auth    │
│ (Create User        │
│  Account)           │
└──────────┬──────────┘
           │
    ┌──────┼──────┐
    │      │      │
    ▼      ▼      ▼
┌──────┐ ┌──────┐ ┌──────┐
│สำเร็จ│ │Email │ │Error │
│      │ │ซ้ำ   │ │      │
└──┬───┘ └──┬───┘ └──┬───┘
   │        │        │
   │        │        │
   │        ▼        ▼
   │ ┌─────────────┐ │
   │ │ Return Error│ │
   │ │ 400/409     │ │
   │ └─────────────┘ │
   │                 │
   ▼                 │
┌─────────────────────┐
│ ตรวจสอบว่ามีข้อมูล BMI│
│ (Check if BMI Data │
│  Provided)         │
└──────────┬──────────┘
           │
    ┌──────┼──────┐
    │      │      │
    ▼      ▼      ▼
┌──────┐ ┌──────┐ ┌──────┐
│มีข้อมูล│ │ไม่มี │ │มีบางส่วน│
│BMI   │ │      │ │      │
└──┬───┘ └──┬───┘ └──┬───┘
   │        │        │
   │        │        │
   │        │        ▼
   │        │ ┌─────────────┐
   │        │ │ Return Error│
   │        │ │ 400         │
   │        │ │ (Missing    │
   │        │ │  Weight/    │
   │        │ │  Height)    │
   │        │ └─────────────┘
   │        │
   │        ▼
   │ ┌─────────────┐
   │ │ ข้ามการบันทึก│
   │ │ BMI         │
   │ │ (Skip BMI   │
   │ │  Record)    │
   │ └──────┬──────┘
   │        │
   │        │
   ▼        │
┌─────────────────────┐
│ ตรวจสอบข้อมูล BMI    │
│ (Validate BMI Data) │
│ - Weight > 0        │
│ - Height > 0        │
│ - Calories >= 0     │
└──────────┬──────────┘
           │
    ┌──────┼──────┐
    │      │      │
    ▼      ▼      ▼
┌──────┐ ┌──────┐ ┌──────┐
│ถูกต้อง│ │ไม่ถูกต้อง│ │Error │
│      │ │      │ │      │
└──┬───┘ └──┬───┘ └──┬───┘
   │        │        │
   │        │        │
   │        ▼        ▼
   │ ┌─────────────┐ │
   │ │ Return Error│ │
   │ │ 400         │ │
   │ │ (Invalid    │ │
   │ │  Data)      │ │
   │ └─────────────┘ │
   │                 │
   ▼                 │
┌─────────────────────┐
│ คำนวณค่า BMI         │
│ (Calculate BMI)     │
│ BMI = weight /      │
│       (height/100)² │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ กำหนด BMI Category   │
│ (Determine Category)│
│ - Underweight       │
│   (BMI < 18.5)      │
│ - Normal            │
│   (18.5 ≤ BMI < 25) │
│ - Overweight        │
│   (25 ≤ BMI < 30)   │
│ - Obese             │
│   (BMI ≥ 30)        │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ บันทึกข้อมูล BMI     │
│ ลง bmi_records      │
│ (Save BMI Record    │
│  to Database)       │
└──────────┬──────────┘
           │
    ┌──────┼──────┐
    │      │      │
    ▼      ▼      ▼
┌──────┐ ┌──────┐ ┌──────┐
│สำเร็จ│ │ล้มเหลว│ │Error │
│      │ │      │ │      │
└──┬───┘ └──┬───┘ └──┬───┘
   │        │        │
   │        │        │
   │        ▼        ▼
   │ ┌─────────────┐ │
   │ │ Return Error│ │
   │ │ 500         │ │
   │ │ (Database   │ │
   │ │  Error)     │ │
   │ └─────────────┘ │
   │                 │
   ▼                 │
┌─────────────────────┐
│ ดึงข้อมูล BMI ทั้งหมด │
│ (Fetch All BMI      │
│  Records)           │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ บันทึก Transaction  │
│ History             │
│ (Log Sign Up        │
│  Transaction)       │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ ส่ง Response กลับ   │
│ (Return Response)   │
│ - User Data         │
│ - Session Token     │
│ - BMI Data          │
│ - BMI History       │
└──────────┬──────────┘
           │
           ▼
        [สิ้นสุด]
```

---

## 4. State Diagram

### 4.1 State Diagram สำหรับ BMI Record

```
┌─────────────────────────────────────────────────────────────┐
│              State Diagram: BMI Record Lifecycle            │
└─────────────────────────────────────────────────────────────┘

                    [เริ่มต้น]
                       │
                       ▼
            ┌─────────────────────┐
            │   ไม่มีข้อมูล BMI    │
            │  (No BMI Data)      │
            └──────────┬──────────┘
                       │
                       │ User สมัครสมาชิกพร้อมข้อมูล BMI
                       │ หรือบันทึกข้อมูล BMI ใหม่
                       │
                       ▼
            ┌─────────────────────┐
            │  กำลังบันทึกข้อมูล    │
            │ (Recording BMI)     │
            └──────────┬──────────┘
                       │
                       │ ระบบคำนวณ BMI
                       │ ระบบกำหนด category
                       │
                       ▼
            ┌─────────────────────┐
            │  บันทึกข้อมูลสำเร็จ   │
            │ (BMI Recorded)     │
            └──────────┬──────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ▼              ▼              ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ Underweight │ │   Normal    │ │ Overweight  │
│  (BMI < 18.5)│ │(18.5 ≤ BMI │ │(25 ≤ BMI <  │
│             │ │    < 25)    │ │    30)      │
└─────────────┘ └─────────────┘ └─────────────┘
        │              │              │
        │              │              │
        └──────────────┼──────────────┘
                       │
                       │ BMI ≥ 30
                       │
                       ▼
            ┌─────────────────────┐
            │      Obese          │
            │   (BMI ≥ 30)       │
            └──────────┬──────────┘
                       │
                       │ User บันทึกข้อมูล BMI ใหม่
                       │
                       ▼
            ┌─────────────────────┐
            │  อัปเดตข้อมูล BMI    │
            │ (Updating BMI)     │
            └──────────┬──────────┘
                       │
                       │ ระบบคำนวณ BMI ใหม่
                       │ ระบบบันทึกเป็น record ใหม่
                       │
                       ▼
            ┌─────────────────────┐
            │  มีประวัติ BMI      │
            │ (BMI History)       │
            └─────────────────────┘
                       │
                       │ User ดูประวัติ
                       │
                       ▼
            ┌─────────────────────┐
            │  แสดงประวัติ BMI    │
            │ (Viewing History)   │
            └─────────────────────┘
```

### 4.2 State Diagram สำหรับ User Authentication

```
┌─────────────────────────────────────────────────────────────┐
│         State Diagram: User Authentication Flow             │
└─────────────────────────────────────────────────────────────┘

                    [เริ่มต้น]
                       │
                       ▼
            ┌─────────────────────┐
            │   ไม่ได้เข้าสู่ระบบ   │
            │   (Not Logged In)   │
            └──────────┬──────────┘
                       │
        ┌───────────────┼───────────────┐
        │               │               │
        │               │               │
        ▼               ▼               ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│  สมัครสมาชิก │ │ เข้าสู่ระบบ  │ │   Guest    │
│ (Sign Up)   │ │ (Sign In)   │ │   Mode     │
└──────┬──────┘ └──────┬──────┘ └──────┬──────┘
       │               │               │
       │               │               │
       ▼               ▼               │
┌─────────────┐ ┌─────────────┐         │
│ กำลังสร้าง   │ │ กำลังตรวจสอบ │         │
│ บัญชี       │ │ ข้อมูล       │         │
│ (Creating)  │ │ (Verifying)│         │
└──────┬──────┘ └──────┬──────┘         │
       │               │                 │
       │               │                 │
       ▼               ▼                 │
┌─────────────┐ ┌─────────────┐         │
│ สร้างสำเร็จ  │ │ ตรวจสอบสำเร็จ│         │
│ (Created)   │ │ (Verified)  │         │
└──────┬──────┘ └──────┬──────┘         │
       │               │                 │
       └───────┬───────┘                 │
               │                         │
               ▼                         │
      ┌─────────────────────┐             │
      │  เข้าสู่ระบบแล้ว     │◄────────────┘
      │  (Logged In)       │
      └──────────┬──────────┘
                 │
                 │ User ใช้งานระบบ
                 │
                 ▼
      ┌─────────────────────┐
      │  กำลังใช้งานระบบ     │
      │  (Active Session)   │
      └──────────┬──────────┘
                 │
                 │ Token หมดอายุ
                 │ หรือ User ออกจากระบบ
                 │
                 ▼
      ┌─────────────────────┐
      │  ออกจากระบบแล้ว       │
      │  (Logged Out)       │
      └─────────────────────┘
                 │
                 │
                 ▼
      ┌─────────────────────┐
      │   ไม่ได้เข้าสู่ระบบ   │
      │   (Not Logged In)   │
      └─────────────────────┘
```

---

## 5. Sequence Diagram

### 5.1 Sequence Diagram: กระบวนการสมัครสมาชิกพร้อมบันทึก BMI

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  User    │    │  Frontend│    │  Backend │    │ Supabase  │    │ Supabase │
│          │    │          │    │   API    │    │   Auth    │    │ Database │
└────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘
     │               │               │               │               │
     │ 1. กรอกข้อมูล  │               │               │               │
     │    (email,    │               │               │               │
     │    password,  │               │               │               │
     │    weight,    │               │               │               │
     │    height)    │               │               │               │
     ├──────────────>│               │               │               │
     │               │               │               │               │
     │               │ 2. POST       │               │               │
     │               │ /api/auth/    │               │               │
     │               │ signup        │               │               │
     │               ├──────────────>│               │               │
     │               │               │               │               │
     │               │               │ 3. signUp()   │               │
     │               │               ├──────────────>│               │
     │               │               │               │               │
     │               │               │ 4. User       │               │
     │               │               │    Created    │               │
     │               │               │<──────────────┤               │
     │               │               │               │               │
     │               │               │ 5. Calculate │               │
     │               │               │    BMI        │               │
     │               │               │               │               │
     │               │               │ 6. Insert    │               │
     │               │               │    BMI Record │               │
     │               │               ├──────────────────────────────>│
     │               │               │               │               │
     │               │               │ 7. BMI       │               │
     │               │               │    Recorded   │               │
     │               │               │<──────────────────────────────┤
     │               │               │               │               │
     │               │               │ 8. Fetch     │               │
     │               │               │    All BMI   │               │
     │               │               │    Records    │               │
     │               │               ├──────────────────────────────>│
     │               │               │               │               │
     │               │               │ 9. BMI       │               │
     │               │               │    History   │               │
     │               │               │<──────────────────────────────┤
     │               │               │               │               │
     │               │ 10. Response │               │               │
     │               │    (user,    │               │               │
     │               │     profile, │               │               │
     │               │     bmi)     │               │               │
     │               │<──────────────┤               │               │
     │               │               │               │               │
     │ 11. แสดงผล    │               │               │               │
     │    ข้อมูล      │               │               │               │
     │<──────────────┤               │               │               │
     │               │               │               │               │
```

### 5.2 Sequence Diagram: กระบวนการเข้าสู่ระบบ

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  User    │    │  Frontend│    │  Backend │    │ Supabase  │    │ Supabase │
│          │    │          │    │   API    │    │   Auth    │    │ Database │
└────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘
     │               │               │               │               │
     │ 1. กรอก       │               │               │               │
     │    email,     │               │               │               │
     │    password   │               │               │               │
     ├──────────────>│               │               │               │
     │               │               │               │               │
     │               │ 2. POST       │               │               │
     │               │ /api/auth/    │               │               │
     │               │ signin        │               │               │
     │               ├──────────────>│               │               │
     │               │               │               │               │
     │               │               │ 3. signInWith│               │
     │               │               │    Password() │               │
     │               │               ├──────────────>│               │
     │               │               │               │               │
     │               │               │ 4. Verify    │               │
     │               │               │    Credentials│               │
     │               │               │               │               │
     │               │               │ 5. User      │               │
     │               │               │    Verified   │               │
     │               │               │    + Session  │               │
     │               │               │<──────────────┤               │
     │               │               │               │               │
     │               │               │ 6. Fetch     │               │
     │               │               │    BMI       │               │
     │               │               │    Records   │               │
     │               │               ├──────────────────────────────>│
     │               │               │               │               │
     │               │               │ 7. BMI       │               │
     │               │               │    Records   │               │
     │               │               │<──────────────────────────────┤
     │               │               │               │               │
     │               │               │ 8. Fetch     │               │
     │               │               │    User      │               │
     │               │               │    Profile   │               │
     │               │               ├──────────────────────────────>│
     │               │               │               │               │
     │               │               │ 9. User      │               │
     │               │               │    Profile   │               │
     │               │               │<──────────────────────────────┤
     │               │               │               │               │
     │               │ 10. Response │               │               │
     │               │    (user,    │               │               │
     │               │     session, │               │               │
     │               │     profile, │               │               │
     │               │     bmi)     │               │               │
     │               │<──────────────┤               │               │
     │               │               │               │               │
     │ 11. แสดงผล    │               │               │               │
     │    ข้อมูล      │               │               │               │
     │<──────────────┤               │               │               │
     │               │               │               │               │
```

### 5.3 Sequence Diagram: กระบวนการสแกนบาร์โค้ดและดึงข้อมูลสินค้า

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  User    │    │  Frontend│    │  Backend │    │  Image   │    │ OpenFood │
│          │    │          │    │   API    │    │Processor │    │  Facts   │
└────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘
     │               │               │               │               │
     │ 1. อัปโหลด    │               │               │               │
     │    รูปภาพ     │               │               │               │
     │    (barcode)  │               │               │               │
     ├──────────────>│               │               │               │
     │               │               │               │               │
     │               │ 2. POST       │               │               │
     │               │ /api/barcode/ │               │               │
     │               │ scan          │               │               │
     │               │ (multipart/  │               │               │
     │               │  form-data)   │               │               │
     │               ├──────────────>│               │               │
     │               │               │               │               │
     │               │               │ 3. Read Image │               │
     │               │               │    with Jimp  │               │
     │               │               ├──────────────>│               │
     │               │               │               │               │
     │               │               │ 4. Image      │               │
     │               │               │    Loaded     │               │
     │               │               │<──────────────┤               │
     │               │               │               │               │
     │               │               │ 5. Process   │               │
     │               │               │    Image      │               │
     │               │               │    (resize,   │               │
     │               │               │     grayscale,│               │
     │               │               │     contrast) │               │
     │               │               │               │               │
     │               │               │ 6. Decode    │               │
     │               │               │    Barcode   │               │
     │               │               │    with ZXing│               │
     │               │               ├──────────────>│               │
     │               │               │               │               │
     │               │               │ 7. Barcode   │               │
     │               │               │    Decoded   │               │
     │               │               │<──────────────┤               │
     │               │               │               │               │
     │               │               │ 8. Get       │               │
     │               │               │    Product   │               │
     │               │               │    by        │               │
     │               │               │    Barcode   │               │
     │               │               ├──────────────────────────────>│
     │               │               │               │               │
     │               │               │ 9. Product   │               │
     │               │               │    Data      │               │
     │               │               │<──────────────────────────────┤
     │               │               │               │               │
     │               │ 10. Response │               │               │
     │               │    (barcode, │               │               │
     │               │     product) │               │               │
     │               │<──────────────┤               │               │
     │               │               │               │               │
     │ 11. แสดงผล    │               │               │               │
     │    ข้อมูล      │               │               │               │
     │    สินค้า      │               │               │               │
     │<──────────────┤               │               │               │
     │               │               │               │               │
```

### 5.4 Sequence Diagram: กระบวนการค้นหาอาหาร

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  User    │    │  Frontend│    │  Backend │    │ OpenFood │
│          │    │          │    │   API    │    │  Facts   │
└────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘
     │               │               │               │
     │ 1. กรอกคำค้นหา │               │               │
     │    (query)    │               │               │
     ├──────────────>│               │               │
     │               │               │               │
     │               │ 2. GET        │               │
     │               │ /api/         │               │
     │               │ openfoodfacts/│               │
     │               │ search?q=...  │               │
     │               ├──────────────>│               │
     │               │               │               │
     │               │               │ 3. Search    │
     │               │               │    Request    │
     │               │               ├──────────────>│
     │               │               │               │
     │               │               │ 4. Process   │
     │               │               │    Search    │
     │               │               │               │
     │               │               │ 5. Products │
     │               │               │    Found     │
     │               │               │<──────────────┤
     │               │               │               │
     │               │               │ 6. Format   │
     │               │               │    Data      │
     │               │               │               │
     │               │ 7. Response   │               │
     │               │    (products, │               │
     │               │     count,    │               │
     │               │     total)    │               │
     │               │<──────────────┤               │
     │               │               │               │
     │ 8. แสดงผล     │               │               │
     │    รายการ      │               │               │
     │    สินค้า      │               │               │
     │<──────────────┤               │               │
     │               │               │               │
```

---

## 6. สรุป

เอกสาร SRS นี้ครอบคลุม:
1. ✅ **Use Case Diagram** - แสดง use cases หลักของระบบทั้งหมด 20 use cases
2. ✅ **DFD Level 0** - Context diagram แสดงความสัมพันธ์ระหว่างระบบกับ external entities
3. ✅ **DFD Level 1** - Process decomposition แสดงกระบวนการหลักภายในระบบ
4. ✅ **State Diagram** - แสดง state transitions สำหรับ BMI Record และ User Authentication
5. ✅ **Sequence Diagram** - แสดง interaction flow สำหรับ:
   - กระบวนการสมัครสมาชิกพร้อมบันทึก BMI
   - กระบวนการเข้าสู่ระบบ
   - กระบวนการสแกนบาร์โค้ดและดึงข้อมูลสินค้า
   - กระบวนการค้นหาอาหาร

เอกสารนี้สามารถใช้เป็นแนวทางในการพัฒนาระบบและทำความเข้าใจการทำงานของระบบ TCX Backend API ได้อย่างครบถ้วน

